name: $(Year:yyyy).$(Date:MMdd).$(rev:rr)-$(Build.SourceBranchName)

trigger:
    - none

variables:
    dockerImageName: 'orders/api'
    buildTarget: '**/*.sln'
    acceptanceTestTarget: '**/*.AcceptanceTests.csproj'
    unitTestTarget: '**/*.UnitTests.csproj'

stages:
- stage: build
  displayName: Build Solution
  jobs:
  - job: build
    displayName: Build Application
    pool:
        vmImage: 'ubuntu-latest'
    steps:
      - template: templates/build-test-steps.yml
      - ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:
        - script: |
            docker build -t $(dockerImageName):$(Build.BuildNumber) -f build/Dockerfile .
          displayName: Build Docker container
        - task: AmazonWebServices.aws-vsts-tools.ECRPushImage.ECRPushImage@1
          displayName: 'Push Image to AWS'
          inputs:
            awsCredentials: 'AWS-JT'
            regionName: 'ap-southeast-2'
            sourceImageName: '$(dockerImageName)'
            sourceImageTag: '$(Build.BuildNumber)'
            repositoryName: '$(dockerImageName)'
            pushTag: '$(Build.BuildNumber)'
            autoCreateRepository: true
        - task: PublishBuildArtifacts@1
          inputs:
            pathToPublish: 'deploy/k8s/'
            artifactName: k8s
              