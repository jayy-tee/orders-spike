name: $(Year:yyyy).$(Date:MMdd).$(rev:rr)-$(Build.SourceBranchName)

trigger:
    - none

variables:
    dockerImageName: 'orders/api'

stages:
- stage: build
  displayName: Build Solution
  jobs:
  - job: build
    displayName: Build Application
    pool:
        vmImage: 'ubuntu-latest'
    steps:
        - task: DotNetCoreCLI@2
          displayName: 'dotnet publish'
          inputs:
            command: publish
            projects: '**/*.sln'
            arguments: '-c Release -p:Version=$(Build.BuildNumber)'
            publishWebProjects: false
            zipAfterPublish: false
        - script: |
            docker build -t $(dockerImageName):$(Build.BuildNumber) -f build/Dockerfile .
          displayName: Build Docker container
        - task: AmazonWebServices.aws-vsts-tools.ECRPushImage.ECRPushImage@1
          displayName: 'Push Image to AWS'
          inputs:
            awsCredentials: 'AWS-JT'
            regionName: 'ap-southeast-2'
            sourceImageName: '$(dockerImageName)'
            sourceImageTag: '$(Build.BuildNumber)'
            repositoryName: '097554245028.dkr.ecr.ap-southeast-2.amazonaws.com/$(dockerImageName)'
            pushTag: '$(Build.BuildNumber)'
            autoCreateRepository: true
          